■ 이슈 키: COMMONR-126
■ 제목: 인증 - BioStar_Mobile Card(NFC지원 / BLE지원)
■ 설명: Mobile Credential Key 
 > PrimaryKey 16Byte, Secondary Key 16Byte


FS 2 기능

*<소개>*
(*) 스마트폰을 카드 처럼 사용할 수 있는 기능이다.
(*) NFC와 BLE 모두 공통으로 적용된다.

*<요구사항>*
(*) Access On Card, Secure Credential Card 용 데이터 구조체를 그대로 사용한다.
(*) 스마트 폰에 Access On Card가 발급된 경우, 장치 인증 모드나 개인인증 모드에 따라서 인증을 수행한다. 단, 개인인증모드가 지문/얼굴을 이용한 인증모드인 경우에는 인증모드 오류로 처리한다. 
(*) 스마트 폰에 Secure Credential Card가 발급된 경우 Secure Credential Card의 Card ID만을 사용하여 CSN으로 처리한다.


<<BioStar2 - 2.7 Upgrade 후 변경 사항>>
※ DESFire Advanced 사용 시 Mobile 설정 불가

<<BioStar2 환경설정 & 발급 및 인증방법에 대한 전체적인 설명>>
※ Cloud 사용시 password level을 medium이상으로 설정
    : 임의 사용자의 권한등급(Administrator)/로그인ID(ex. test)/암호(ex. test1234!1) 설정

1. BioStar2 Cloud 설정
    : Subdomain Name - 정규서버와 중복되지 않도록 설정(ex. aaa.biostar2.com)
    : Administrator e-mail 설정 - ex. sykim@suprema.co.kr
    : Cloud Server Address - apitest.biostar2.com 으로 변경
    : Port Used by Cloud - 설정값 유지(52000)
    : Version - v2 으로 설정

2. Email 수신
    : Cloud 설정 적용시 Administrator e-mail에 설정한 주소로 biostar2에서 메일발송
      => 해당 메일에서 https://api.biostar2.com/v2~ 클릭> 웹 브라우저에서 URL을 api.biostar2.com -> apitest.biostar2.com으로 수정해 재접속

3. Register to Biostar2  Cloud 화면
    : Login ID 및 Password 입력(test/test1234!1)

4. Mobile 접속 설정(Play Store에서 Download)
    => Subdomain Name & Cloud Server Address 입력(abc.apitest.biostar2.com)
    => Login ID 및 Password 입력(test/test1234!1)
    : 로그인 후 설정에서 BLE 선택
    ※ NFC 로 동작시킬 경우 BLE Disable 후 기기설정에서 블루투스 해제 & NFC Enable 후 사용

5. 장치의 layout 설정
    : 설정> 카드형식> 스마트 카드> 스마트 카드 추가> DesFire/모바일 탭에서 Layout 설정 후 Device에서 해당 Layout 설정

6. 모바일 접속 사용자에게 모바일카드 발급
    : test/test1234!1 설정된 사용자> 카드> 스마트 카드> Layout 설정된 장치 선택> 각 항목 선택 후 모바일카드 발급 클릭

7. Mobile UI에서 느낌표 출력> 클릭> 카드클릭 후 인증


※ FS2 - AWB 모델: NFC/BLE 지원
※ FS2-D 모델: NFC 만 지원(BLE 미지원)
============================================================

■ 테스트 스텝

[Step 1]
스텝 (Step)
1. Setting> Server> User/Device Management
2. Mobile Card > 설정

데이터 (Data)
1. Mobile Card 
 > Enable
 > Disable (Default)

예상 결과 (Expected Result)
1. Mobile Card 발급이 활성화된 경우, 사용자에서 Smart Card Enroll 시 모바일 카드 발급 버튼이 생성된다.
2. 활성화된 경우 지원 환경 정보가 표시된다.
------------------------------------------------------------
[Step 2]
스텝 (Step)
1. Setting> Card Format> Smart Card> Add Smart Card
2. Primary Key 설정
3. Secondary Key 사용여부 설정
4. Device> 상세정보진입> Layout 설정
5. User> 기 등록된 사용자 선택> Card> SmartCard> 사용자 정보 Write

※ Access On/Secure Credential Card 모두 확인사항

데이터 (Data)
카드발급
> Moblie Card

예상 결과 (Expected Result)
사용자 정보가 카드에 Write 되어야 한다.
------------------------------------------------------------
[Step 3]
스텝 (Step)
1. Setting> Card Format> Smart Card> Add Smart Card> DESFire / Mobile
2. Key 설정
3. Device> 상세정보진입> Layout 설정
4. User> 기 등록된 사용자 선택> Card> Smart Card> 사용자 정보 Write
6. BioStar V2.7 Upgrade
7. DESFire, Mobile> 인증

※ Access On/Secure Credential Card 모두 확인사항

데이터 (Data)
카드발급 - BioStar V2.7 이전
> Moblie Card

예상 결과 (Expected Result)
1. 사용자 정보가 카드에 Write 된다.
2. BioStar V2.7 Upgrade 이후 DESFire, Mobile Card Format이 기존 처럼 표시
3. Smart Card(AOC, SCC) 인증 성공된다.
> DESFire Advanced 사용 시 Mobile 설정 불가
------------------------------------------------------------
[Step 4]
스텝 (Step)
<Card Format 설정 & 장치에 Layout 설정된 상태>
1. User> 기 등록된 사용자 선택> Card> Read Card> Format Card
2. SmartCard> Secure Credential 카드에 사용자 정보 Write

데이터 (Data)
사용자 ID
 > 숫자 : 기존과 동일
 > 영숫자 : Default(공란), 24 byte 범위 내에서 10진수 숫자 1 부터 입력 지원

예상 결과 (Expected Result)
> 출입그룹 정보는 장치에 저장되어야 하고, 카드ID/지문/PIN 정보만 저장되어야 한다.
> 카드 Type/Template 개수/발급회차가 저장되어야 한다.
------------------------------------------------------------
[Step 5]
스텝 (Step)
1. Step 4에서 발급한 Secure Credential 카드 인증시도

데이터 (Data)
인증시도
> 단일장치
> Master-Slave 장치
> 장치 인증 모드별
=: Card, 이중인증, 근태, 권한별 메뉴 진입
> 개인 인증 모드

예상 결과 (Expected Result)
> SCC의 경우 장치에 저장된 사용자 정보로 매칭이 이루어진다.

:= Wiegand Reader는 본래의 Card ID값인 CSN 값으로 내보내기에 Smart Card와 무관함.
------------------------------------------------------------
[Step 6]
스텝 (Step)
<Card Format 설정 & 장치에 Layout 설정된 상태>
1. User> 기 등록된 사용자 선택> Card> Read Card> Format Card
2. SmartCard> Access On 카드에 사용자 정보 Write

데이터 (Data)
사용자 ID
 > 숫자, 영숫자, 특수 문자('_','-')

포맷
> 영숫자 모드가 불일치 해도 카드 레이아웃만 동일하면 장치 상관 없이 가능
: 영숫자 모드 불일치, 미지원 FW

예상 결과 (Expected Result)
> ID와 Credential을 포함해 인증에 필요한 모든 정보가 저장되어야 한다.
> Access On 카드 Write시 발급회차가 발급되어야 한다.
------------------------------------------------------------
[Step 7]
스텝 (Step)
1. Step 5에서 발급한 Access On 카드 인증시도

데이터 (Data)
인증시도
> 단일장치
> Master-Slave 장치
> 장치 인증 모드별
=: Card, 이중인증, 근태, 권한별 메뉴 진입
> 개인 인증 모드

예상 결과 (Expected Result)
> 카드에 발급된 정보로 인증된다.
=: Wiegand Out(Access On Card 발급 장치) - Card ID 출력 됨
> 인증 성공 팝업에는 사용자 ID 만 표시된다.(장치에서 확인) 
:= Wiegand Reader는 본래의 Card ID값인 CSN 값으로 내보내기에 Smart Card와 무관함.
------------------------------------------------------------
[Step 8]
스텝 (Step)
1. Device> Layout 설정
2. User> AOC/SCC Mobile 카드 발급
3. 발급받은 카드로 인증시도

데이터 (Data)
N/A

예상 결과 (Expected Result)
1. 인증시 인증결과에 대해 동일한 카드ID로 인증되어야 한다.
=> 인증할때마다 랜덤한 ID로 인증되지 않아야 한다.
------------------------------------------------------------
[Step 9]
스텝 (Step)
1. Device> Layout 설정
2. User> 개인인증모드 설정> AOC 카드발급> Private Auth Mode 설정
3. 발급받은 카드로 인증시도

데이터 (Data)
사용자 ID
 > 숫자, 영숫자, 특수 문자('_','-')
Private Auth Mode
 > Card Only / Card + PIN / Card+FP / Card + FP or PIN / Card + FP + PIN

예상 결과 (Expected Result)
1. AOC 카드에 Write된 개인인증모드로 동작되어야 한다.
> Server&Device encryption key manual management: Use(수동 Hash Key)설정 시 PIN이 포함된 경우 발급 전후의 설정이  달라진 경우 인증 실패 발생
------------------------------------------------------------
[Step 10]
스텝 (Step)
0. Setting > Server > User/Device Management 에서 'AoC 발급 시 개인정보 삭제' : Enable
1. Device> Layout 설정
2. User> 개인인증모드 설정> AOC 카드발급> Private Auth Mode 설정
3. 발급받은 카드로 인증시도

데이터 (Data)
사용자 ID
 > 숫자, 영숫자, 특수 문자('_','-')
Private Auth Mode
 > Card Only / Card + PIN / Card+FP / Card + FP or PIN / Card + FP + PIN
Private Info
 > FP, PIN, Face, Email, Phone, Birthday , Gender
(birthday, gender는 DB에만 존재하는 data)

예상 결과 (Expected Result)
1.AOC 카드 발급 성공 시 사용자의 개인정보가 삭제된다.(SCC는 유지)
2.AOC 카드에 Write된 개인인증모드로 동작되어야 한다.
> FW 지원 유무에 따라 미지원 버전은 개인 인증 모드를 무시하고 동작, BioStar에서 발급 시에는 FW 버전 상관 없이 Private Auth 발급 가능
------------------------------------------------------------
